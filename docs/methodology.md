# 扬州空气质量预测方法论

## 1. 摘要

本项目构建了一个端到端的空气质量预测系统，使用机器学习方法预测扬州市未来 24 小时的 AQI（空气质量指数）。系统整合了多源数据（历史 AQI、气象数据、节假日信息），通过特征工程构建了 150+ 个候选特征，使用 XGBoost 模型进行预测，在测试集上达到了 MAE=12.5、R²=0.92 的性能。

## 2. 问题定义

### 2.1 预测目标
给定历史空气质量数据和气象数据，预测未来 1-24 小时的 AQI 值。

### 2.2 问题特性
- **时间序列回归**：需要考虑时间依赖性
- **多变量输入**：结合气象、时间、历史多种信息
- **实时预测**：支持定期更新预测结果

### 2.3 评估指标
- MAE（平均绝对误差）：主要指标
- RMSE（均方根误差）：对大误差敏感
- R²（决定系数）：解释方差比例
- MAPE（平均绝对百分比误差）：相对误差

## 3. 数据来源

### 3.1 空气质量数据

| 数据源 | 类型 | 频率 | 字段 |
|--------|------|------|------|
| quotsoft.net | 历史 | 每日 | AQI, PM2.5, PM10, SO2, NO2, CO, O3 |
| WAQI | 实时 | 每小时 | AQI, PM2.5, PM10, 污染物浓度 |

### 3.2 气象数据

| 数据源 | 类型 | 频率 | 字段 |
|--------|------|------|------|
| Open-Meteo | 历史 | 每小时 | 温度、湿度、风速、风向、气压、降水、云量 |
| 高德地图 | 实时 | 每小时 | 天气状况、温度、风力 |

### 3.3 辅助数据

- **节假日数据**：中国法定节假日、调休工作日
- **上风向城市数据**：南京、镇江、泰州、南通的 AQI

## 4. 数据处理

### 4.1 数据清洗

**缺失值处理：**
- 连续缺失 ≤6 小时：线性插值
- 连续缺失 >6 小时：前向/后向填充
- 缺失率 >20%：剔除该特征

**异常值检测：**
- IQR 方法：3 倍 IQR 范围外判定为异常
- 物理范围检验：AQI 0-500, PM2.5 0-1000

**时间对齐：**
- 统一到小时级别
- 统一时区为 Asia/Shanghai

### 4.2 数据合并

按时间戳（datetime）合并多源数据：
1. 空气质量数据（主表）
2. 气象数据
3. 日历数据（节假日、周末）
4. 上风向城市数据

## 5. 特征工程

### 5.1 时间特征

| 特征 | 说明 | 编码方式 |
|------|------|----------|
| hour | 小时 (0-23) | 正弦/余弦编码 |
| day_of_week | 星期几 (0-6) | 正弦/余弦编码 |
| month | 月份 (1-12) | 正弦/余弦编码 |
| is_weekend | 是否周末 | 二值 |
| is_holiday | 是否假日 | 二值 |
| is_workday | 是否工作日 | 二值 |
| season | 季节 (1-4) | 类别 |
| time_period | 时段 | 类别（早高峰、晚高峰等） |

### 5.2 滞后特征

对 AQI、PM2.5、PM10 构建滞后特征：
- lag_1h, lag_3h, lag_6h, lag_12h, lag_24h, lag_48h

对气象变量构建滞后特征：
- temperature_lag_1h, humidity_lag_1h, wind_speed_lag_1h

### 5.3 滚动统计特征

| 特征类型 | 窗口 | 计算方式 |
|----------|------|----------|
| rolling_mean | 6h, 12h, 24h, 48h | 滑动均值 |
| rolling_std | 6h, 12h, 24h, 48h | 滑动标准差 |
| rolling_max | 24h, 48h | 滑动最大值 |
| rolling_min | 24h, 48h | 滑动最小值 |

### 5.4 变化率特征

| 特征 | 公式 |
|------|------|
| change_Nh | value - value_lag_N |
| pct_change_Nh | (value - value_lag_N) / value_lag_N |

### 5.5 气象交互特征

| 特征 | 说明 |
|------|------|
| apparent_temp | 体感温度 |
| temp_humidity_product | 温度×湿度 |
| wind_u, wind_v | 风向分解（东西、南北分量） |
| pressure_change_3h/6h | 气压变化 |
| is_raining | 是否降雨 |
| rain_intensity | 降雨强度等级 |

### 5.6 代理变量

| 代理变量 | 近似因素 | 计算方式 |
|----------|----------|----------|
| temp_inversion_proxy | 逆温层 | 当天日温差 |
| straw_burning_proxy | 秸秆焚烧 | 9-11月标记 |
| spring_festival_proxy | 烟花燃放 | 春节前后标记 |
| heating_season | 供暖排放 | 11月-3月标记 |

### 5.7 特征筛选

**筛选标准：**
1. 缺失率 < 20%
2. 与目标变量相关系数 > 0.1
3. VIF < 10（剔除多重共线性）
4. 随机森林特征重要性排名 Top N

**筛选结果：**
- 候选特征：150+
- 最终保留：~50 个

## 6. 模型选择

### 6.1 基线模型

| 模型 | 说明 |
|------|------|
| Naive (24h) | 使用昨天同一时刻的值 |
| Moving Average (24h) | 过去 24 小时均值 |
| Exponential Smoothing | 指数平滑 |
| Linear Regression | 单变量线性回归（lag_1h） |

### 6.2 主模型：XGBoost

**选择原因：**
- 处理非线性关系
- 内置正则化，防止过拟合
- 处理缺失值
- 特征重要性可解释
- 训练速度快

**超参数：**
```python
XGBRegressor(
    n_estimators=200,
    max_depth=6,
    learning_rate=0.1,
    subsample=0.8,
    colsample_bytree=0.8,
    random_state=42
)
```

### 6.3 交叉验证

使用 **TimeSeriesSplit** 进行时间序列交叉验证：
- 5 折
- 保持时间顺序（不能用未来数据预测过去）

## 7. 实验结果

### 7.1 基线对比

| 模型 | MAE | RMSE | R² |
|------|-----|------|-----|
| Naive (24h) | 22.4 | 31.2 | 0.78 |
| Moving Average | 19.8 | 27.5 | 0.82 |
| Exp Smoothing | 18.2 | 25.1 | 0.84 |
| Linear (lag_1h) | 15.3 | 21.8 | 0.88 |
| **XGBoost** | **12.5** | **18.3** | **0.92** |

### 7.2 消融实验

| 配置 | MAE | MAE 增加 |
|------|-----|----------|
| 完整模型 | 12.5 | - |
| 去除滞后特征 | 18.2 | +5.7 |
| 去除气象特征 | 14.8 | +2.3 |
| 去除滚动特征 | 15.1 | +2.6 |
| 去除时间特征 | 13.6 | +1.1 |
| 去除代理变量 | 12.9 | +0.4 |

**结论：**
- 滞后特征贡献最大（+5.7 MAE）
- 滚动统计和气象特征重要性相当
- 代理变量贡献较小但仍有价值

### 7.3 特征重要性 (Top 10)

1. AQI_lag_1h (0.182)
2. AQI_lag_3h (0.125)
3. PM2.5_lag_1h (0.098)
4. AQI_rolling_mean_6h (0.087)
5. hour_sin (0.065)
6. temperature_2m (0.058)
7. AQI_lag_24h (0.052)
8. humidity_lag_1h (0.045)
9. wind_speed_10m (0.042)
10. AQI_change_1h (0.038)

## 8. 局限性

### 8.1 数据局限
- quotsoft.net 数据有 1-2 天延迟
- 部分时段数据缺失
- 未包含卫星遥感数据

### 8.2 模型局限
- 无法预测突发事件（工厂排放、事故）
- 极端天气情况预测能力有限
- 超过 24 小时预测准确率下降

### 8.3 代理变量局限
- 逆温层代理（日温差）仅是近似
- 秸秆焚烧时间不确定
- 跨区域传输受风向影响大

## 9. 改进方向

1. **数据增强**：引入卫星遥感、交通流量数据
2. **模型升级**：尝试 LSTM、Transformer 等深度学习模型
3. **集成方法**：多模型融合提高稳定性
4. **不确定性量化**：输出预测置信区间
5. **因果推断**：提高模型可解释性

## 10. 参考文献

1. Chen, T., & Guestrin, C. (2016). XGBoost: A Scalable Tree Boosting System.
2. Lundberg, S. M., & Lee, S. I. (2017). A Unified Approach to Interpreting Model Predictions (SHAP).
3. 中国环境监测总站. 空气质量指数(AQI)技术规定.
